<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Terra Indomita &mdash; École de plein air</title>
    <link rel="icon" type="image/png" href="./assets/images/favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./assets/css/styles.css" />
  </head>
  <body>
    <header class="hero" id="accueil">
      <div class="hero__overlay">
        <div class="hero__crest">
          <picture>
            <source srcset="./assets/images/logo-crest.svg" type="image/svg+xml" />
            <img src="./assets/images/logo-crest.png" alt="Blason Terra Indomita" />
          </picture>
        </div>
        <div class="hero__content">
          <h1>École de plein air</h1>
          <ul class="hero__list">
            <li>Stage de formation</li>
            <li>Camp immersif</li>
            <li>Mentorat privé</li>
          </ul>
        </div>
      </div>
    </header>

    <main>
      <section class="section section--dark" id="presentation">
        <div class="container two-columns">
          <div class="media">
            <picture>
              <source srcset="./assets/images/logo-crest.svg" type="image/svg+xml" />
              <img src="./assets/images/logo-crest.png" alt="Blason Terra Indomita" class="media__image" />
            </picture>
          </div>
          <div class="copy">
            <p class="eyebrow">Qui sommes-nous</p>
            <p>
              <strong>Terra Indomita</strong> est une école de plein air qui offre des
              stages et des camps immersifs pour développer votre autonomie en plein
              air, en vue d’activités de plein air planifiées ou simplement pour
              approfondir vos connaissances pour le plaisir, ou pour vous préparer à
              faire face à des bris de normalité.
            </p>
          </div>
        </div>
      </section>

      <section class="section section--light" id="services">
        <div class="container">
          <p class="eyebrow eyebrow--dark">Ce que nous offrons</p>
          <div class="offer-grid">
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-stage-formation.jpg"
                  alt="Participants sous un abri en forêt"
                />
              </div>
              <h2>Stage de formation</h2>
              <p>
                Les stages sont la porte d’entrée au monde de l’autonomie en plein
                air. Venez apprendre ou consolider vos connaissances et pratiquer
                dans un cadre éducatif et familial. Accessible, peu importe votre
                condition physique. Disponible aux formats 4 h, 8 h, 48 h et plus.
              </p>
            </article>
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-camp-immersif.jpg"
                  alt="Campement en pleine forêt"
                />
              </div>
              <h2>Camp immersif</h2>
              <p>
                Venez tester vos connaissances et aptitudes dans un événement en
                pleine nature. Construction d’abris naturels, bushcraft, bivouac,
                cuisine en pleine nature, cueillette, chasse et pêche. Comme nos
                arrière-grands-parents !
              </p>
              <p>
                Nécessite une bonne forme physique pour les déplacements en milieu
                sauvage.
              </p>
            </article>
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-mentorat-prive.jpg"
                  alt="Lecture de carte et boussole"
                />
              </div>
              <h2>Mentorat privé</h2>
              <p>
                Vous souhaitez définir vos besoins et votre niveau, pour vous,
                vos proches ou votre famille. Nous offrons
                également des stages et des camps immersifs privés.
              </p>
            </article>
          </div>
        </div>
      </section>

      <section class="section section--dark" id="fondateur">
        <div class="container two-columns">
          <div class="media">
            <img
              src="./assets/images/fondateur-alex.jpg"
              alt="Portrait d'Alex, fondateur de Terra Indomita"
              class="media__image"
            />
          </div>
          <div class="copy">
            <p class="eyebrow">À propos du fondateur</p>
            <p>
              Depuis maintenant huit ans, Alex se passionne pour
              la survie en forêt, l’autonomie en plein air, le
              savoir ancestral et bien plus encore.
            </p>
            <p>
              Il s’est formé auprès d’écoles bien établies au
              Québec, telles que Les Primitifs, Kanatha-Aki et
              Un Goût de Forêt. En plus de ses compétences en
              survie et en vie en nature, Alex est secouriste
              formé et cumule plus de dix ans d’expérience dans
              le domaine de la sécurité privée.
            </p>
            <p>
              Après avoir passé plusieurs années à organiser des
              activités de plein air avec sa famille et ses amis,
              il a maintenant décidé de transmettre sa passion au
              plus grand nombre.
            </p>
            <p>
              Alex prône une approche inclusive et sans jugement
              du monde. Le respect, l’entraide et le plaisir font
              partie de ses valeurs profondes.
            </p>
          </div>
        </div>

      </section>

      <section class="section section--light section--events" id="evenements">
        <div class="container">
          <p class="eyebrow eyebrow--dark">Événements</p>

          <div id="events-status" class="events-status" role="status">
            Chargement des événements…
          </div>

          <div id="events-calendar" class="calendar" hidden data-calendar>
            <div class="calendar__header">
              <button
                type="button"
                class="calendar__nav calendar__nav--prev"
                aria-label="Mois précédent"
              >
                ‹
              </button>

              <h2 id="calendar-month" class="calendar__month" aria-live="polite"></h2>

              <button
                type="button"
                class="calendar__nav calendar__nav--next"
                aria-label="Mois suivant"
              >
                ›
              </button>
            </div>

            <div class="calendar__weekdays" aria-hidden="true">
              <span>Lun</span>
              <span>Mar</span>
              <span>Mer</span>
              <span>Jeu</span>
              <span>Ven</span>
              <span>Sam</span>
              <span>Dim</span>
            </div>

            <div
              id="calendar-grid"
              class="calendar__grid"
              role="grid"
              aria-labelledby="calendar-month"
            ></div>
          </div>
        </div>
      </section>

      <div id="event-modal" class="event-modal" hidden aria-hidden="true">
        <div class="event-modal__backdrop" data-modal-dismiss></div>
        <div
          class="event-modal__dialog"
          role="dialog"
          aria-modal="true"
          aria-labelledby="event-modal-title"
          tabindex="-1"
        >
          <button
            type="button"
            class="event-modal__close"
            data-modal-dismiss
            aria-label="Fermer"
          >
            ×
          </button>
          <h3 id="event-modal-title" class="event-modal__title"></h3>
          <div id="event-modal-content" class="event-modal__content"></div>
          <p id="event-modal-empty" class="event-modal__empty" hidden>
            Aucun événement n’est prévu pour cette date.
          </p>
        </div>
      </div>

      <template id="event-detail-template">
        <article class="event-detail">
          <img class="event-detail__image" alt="" hidden />
          <h4 class="event-detail__title"></h4>
          <p class="event-detail__datetime"></p>
          <p class="event-detail__location" hidden></p>
          <p class="event-detail__description" hidden></p>
        </article>
      </template>

      <section class="section section--dark section--contacts" id="contact">
        <div class="container">
          <p class="eyebrow">CONTACTS</p>
          <div class="contact-list">
            <a class="contact" href="https://www.facebook.com/profile.php?id=61576874895617" target="_blank" rel="noopener">
              <img
                src="./assets/images/f.webp"
                alt="Facebook"
              />
              <span>Facebook</span>
            </a>
            <a class="contact" href="https://www.instagram.com/terra_indomita_qc" target="_blank" rel="noopener">
              <img
                src="./assets/images/i.webp"
                alt="Instagram"
              />
              <span>Instagram</span>
            </a>
            <a class="contact" href="mailto:terra_indomita@outlook.com">
              <img
                src="./assets/images/@.png"
                alt="Courriel"
              />
              <span>terra_indomita@outlook.com</span>
            </a>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <small>© <span id="current-year"></span> Terra Indomita. Tous droits réservés.</small>
      </div>
    </footer>

    <script>
      (function () {
        const ASSET_BASE_URL = 'https://api.terra-indomita.ca/assets/';

        const yearNode = document.getElementById('current-year');
        if (yearNode) {
          yearNode.textContent = new Date().getFullYear();
        }

        document.querySelectorAll('img').forEach((image) => {
          image.addEventListener('error', () => {
            console.warn('Image introuvable:', image.getAttribute('src'));
          });
        });

        const statusNode = document.getElementById('events-status');
        const calendarNode = document.getElementById('events-calendar');
        const gridNode = document.getElementById('calendar-grid');
        const monthNode = document.getElementById('calendar-month');
        const prevBtn = calendarNode?.querySelector('.calendar__nav--prev');
        const nextBtn = calendarNode?.querySelector('.calendar__nav--next');

        const modalNode = document.getElementById('event-modal');
        const modalDialog = modalNode?.querySelector('.event-modal__dialog');
        const modalContent = document.getElementById('event-modal-content');
        const modalTitle = document.getElementById('event-modal-title');
        const modalEmpty = document.getElementById('event-modal-empty');
        const modalDismissEls = modalNode?.querySelectorAll('[data-modal-dismiss]');
        const detailTemplate = document.getElementById('event-detail-template');

        if (
          !statusNode ||
          !calendarNode ||
          !gridNode ||
          !monthNode ||
          !modalNode ||
          !modalDialog ||
          !modalContent ||
          !modalTitle ||
          !modalDismissEls ||
          !detailTemplate
        ) {
          return;
        }

        const EVENTS_URL =
          'https://api.terra-indomita.ca/items/events?sort=start&fields=title,start,end,location,description,featured_image';
        const SETTINGS_URL = 'https://api.terra-indomita.ca/items/global_settings';

        const today = new Date();
        const todayKey = formatDateKey(today);
        let previousFocus = null;

        const state = {
          events: [],
          showCurrentEvents: true,
          monthCursor: new Date(today.getFullYear(), today.getMonth(), 1),
          eventsByDay: new Map(),
        };

        function formatDateKey(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        }

        function truncateToLocalDay(date) {
          return new Date(date.getFullYear(), date.getMonth(), date.getDate());
        }

        function computeStatus(event) {
          const now = new Date();
          const start = event.start ? new Date(event.start) : null;
          const end = event.end ? new Date(event.end) : null;

          if (!start) return 'past';
          if (start > now) return 'upcoming';

          const sameDay = start.toDateString() === now.toDateString();
          const stillRunning = end ? now <= end : sameDay;

          if (stillRunning && state.showCurrentEvents) {
            return 'current';
          }

          return 'past';
        }

        function hydrateEventsByDay() {
          state.eventsByDay.clear();

          state.events.forEach((event) => {
            const start = event.start ? new Date(event.start) : null;
            if (!start) return;

            const end = event.end ? new Date(event.end) : null;
            const startDay = truncateToLocalDay(start);
            const endDay = truncateToLocalDay(end || start);

            for (let cursor = new Date(startDay); cursor <= endDay; cursor.setDate(cursor.getDate() + 1)) {
              const key = formatDateKey(cursor);
              const existing = state.eventsByDay.get(key) || [];
              existing.push(event);
              state.eventsByDay.set(key, existing);
            }
          });
        }

        function getDayStatus(eventsForDay) {
          let hasUpcoming = false;
          let hasCurrent = false;

          eventsForDay.forEach((event) => {
            const status = computeStatus(event);
            if (status === 'upcoming') hasUpcoming = true;
            if (status === 'current') hasCurrent = true;
          });

          if (hasUpcoming) return 'upcoming';
          if (hasCurrent) return 'current';
          return 'past';
        }

        function showLoadingSkeleton() {
          calendarNode.hidden = false;
          calendarNode.classList.add('calendar--loading');
          gridNode.classList.add('calendar__grid--loading');
          gridNode.innerHTML = '';
          const placeholderCount = 42;
          for (let i = 0; i < placeholderCount; i += 1) {
            const placeholder = document.createElement('div');
            placeholder.className = 'calendar__cell calendar__cell--placeholder';
            gridNode.appendChild(placeholder);
          }
        }

        function renderCalendar() {
          calendarNode.classList.remove('calendar--loading');
          gridNode.classList.remove('calendar__grid--loading');
          gridNode.innerHTML = '';

          const year = state.monthCursor.getFullYear();
          const month = state.monthCursor.getMonth();
          const firstDay = new Date(year, month, 1);
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const startOffset = (firstDay.getDay() + 6) % 7;

          monthNode.textContent = new Intl.DateTimeFormat('fr-CA', {
            month: 'long',
            year: 'numeric',
          }).format(state.monthCursor);

          for (let i = 0; i < startOffset; i += 1) {
            const filler = document.createElement('div');
            filler.className = 'calendar__cell calendar__cell--filler';
            filler.setAttribute('role', 'gridcell');
            gridNode.appendChild(filler);
          }

          for (let day = 1; day <= daysInMonth; day += 1) {
            const cellDate = new Date(year, month, day);
            const dateKey = formatDateKey(cellDate);
            const eventsForDay = state.eventsByDay.get(dateKey) || [];
            const hasEvents = eventsForDay.length > 0;
            const isToday = dateKey === todayKey;

            const cell = document.createElement(hasEvents ? 'button' : 'div');
            cell.className = 'calendar__cell';
            cell.setAttribute('role', 'gridcell');

            if (hasEvents) {
              cell.type = 'button';
              cell.classList.add('calendar__cell--interactive', 'calendar__cell--has-events');
              const status = getDayStatus(eventsForDay);
              cell.classList.add(`calendar__cell--status-${status}`);

              const indicator = document.createElement('span');
              indicator.className = 'calendar__indicator';
              cell.appendChild(indicator);

              cell.addEventListener('click', () => openModal(dateKey));
            } else {
              cell.tabIndex = -1;
            }

            if (isToday) {
              cell.classList.add('calendar__cell--today');
            }

            const label = new Intl.DateTimeFormat('fr-CA', {
              weekday: 'long',
              day: 'numeric',
              month: 'long',
              year: 'numeric',
            }).format(cellDate);

            cell.setAttribute(
              'aria-label',
              hasEvents ? `${label}. ${eventsForDay.length} événement(s)` : label
            );

            const number = document.createElement('span');
            number.className = 'calendar__date';
            number.textContent = day;
            cell.appendChild(number);

            gridNode.appendChild(cell);
          }
        }

        function fillModal(dateKey) {
          const [year, month, day] = dateKey.split('-').map(Number);
          const displayDate = new Date(year, month - 1, day);
          const eventsForDay = (state.eventsByDay.get(dateKey) || []).slice().sort((a, b) => {
            const aStart = a.start ? new Date(a.start) : new Date(0);
            const bStart = b.start ? new Date(b.start) : new Date(0);
            return aStart - bStart;
          });

          modalTitle.textContent = new Intl.DateTimeFormat('fr-CA', {
            dateStyle: 'full',
          }).format(displayDate);

          modalContent.innerHTML = '';

          if (!eventsForDay.length) {
            modalEmpty.hidden = false;
            return;
          }

          modalEmpty.hidden = true;

          const dateFormatter = new Intl.DateTimeFormat('fr-CA', { dateStyle: 'long' });
          const timeFormatter = new Intl.DateTimeFormat('fr-CA', { timeStyle: 'short' });

          eventsForDay.forEach((event) => {
            const fragment = detailTemplate.content.cloneNode(true);
            const imageNode = fragment.querySelector('.event-detail__image');
            const titleNode = fragment.querySelector('.event-detail__title');
            const datetimeNode = fragment.querySelector('.event-detail__datetime');
            const locationNode = fragment.querySelector('.event-detail__location');
            const descriptionNode = fragment.querySelector('.event-detail__description');

            titleNode.textContent = event.title ?? 'Événement Terra Indomita';

            const start = event.start ? new Date(event.start) : null;
            const end = event.end ? new Date(event.end) : null;

            if (!start) {
              datetimeNode.textContent = 'Date à confirmer';
            } else if (!end) {
              datetimeNode.textContent = `${dateFormatter.format(start)} · ${timeFormatter.format(start)}`;
            } else if (start.toDateString() === end.toDateString()) {
              datetimeNode.textContent = `${dateFormatter.format(start)} · ${timeFormatter.format(start)} – ${timeFormatter.format(end)}`;
            } else {
              datetimeNode.textContent = `${dateFormatter.format(start)} → ${dateFormatter.format(end)}`;
            }

            if (event.location) {
              locationNode.hidden = false;
              locationNode.textContent = event.location;
            }

            if (event.description) {
              descriptionNode.hidden = false;
              descriptionNode.textContent = '';
              String(event.description)
                .split(/\r?\n/)
                .forEach((line, index) => {
                  if (index > 0) {
                    descriptionNode.appendChild(document.createElement('br'));
                  }
                  descriptionNode.appendChild(document.createTextNode(line));
                });
            }

            if (event.imageUrl) {
              imageNode.hidden = false;
              imageNode.src = event.imageUrl;
              imageNode.alt = event.title || 'Illustration de l’événement';
            }

            modalContent.appendChild(fragment);
          });
        }

        function openModal(dateKey) {
          previousFocus = document.activeElement;
          fillModal(dateKey);
          modalNode.hidden = false;
          modalNode.setAttribute('aria-hidden', 'false');
          modalDialog.focus();
          document.body.classList.add('modal-open');
        }

        function closeModal() {
          modalNode.hidden = true;
          modalNode.setAttribute('aria-hidden', 'true');
          modalContent.innerHTML = '';
          modalEmpty.hidden = true;
          document.body.classList.remove('modal-open');
          if (previousFocus && typeof previousFocus.focus === 'function') {
            previousFocus.focus();
          }
        }

        modalDismissEls.forEach((el) => {
          el.addEventListener('click', closeModal);
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modalNode.getAttribute('aria-hidden') === 'false') {
            closeModal();
          }
        });

        function changeMonth(offset) {
          state.monthCursor.setMonth(state.monthCursor.getMonth() + offset);
          renderCalendar();
        }

        prevBtn.addEventListener('click', () => changeMonth(-1));
        nextBtn.addEventListener('click', () => changeMonth(1));

        function normaliseEvents(rawEvents) {
          return rawEvents
            .map((event) => {
              const start = event.start ? new Date(event.start) : null;
              const end = event.end ? new Date(event.end) : null;

              return {
                title: event.title?.trim() || 'Événement Terra Indomita',
                start: event.start ?? null,
                end: event.end ?? null,
                location: event.location?.trim() || '',
                description: event.description?.trim() || '',
                imageUrl: event.featured_image ? `${ASSET_BASE_URL}${event.featured_image}` : '',
              };
            })
            .filter((event) => Boolean(event.start))
            .sort((a, b) => {
              const aStart = a.start ? new Date(a.start) : new Date(0);
              const bStart = b.start ? new Date(b.start) : new Date(0);
              return aStart - bStart;
            });
        }

        async function loadEvents() {
          try {
            showLoadingSkeleton();

            const [eventsRes, settingsRes] = await Promise.all([
              fetch(EVENTS_URL, { headers: { Accept: 'application/json' } }),
              fetch(SETTINGS_URL, { headers: { Accept: 'application/json' } }),
            ]);

            if (!eventsRes.ok || !settingsRes.ok) {
              throw new Error(`Bad response: ${eventsRes.status}/${settingsRes.status}`);
            }

            const eventsPayload = await eventsRes.json();
            const settingsPayload = await settingsRes.json();

            state.events = normaliseEvents(Array.isArray(eventsPayload?.data) ? eventsPayload.data : []);
            state.showCurrentEvents =
              (Array.isArray(settingsPayload?.data)
                ? settingsPayload.data[0]?.showCurrentEvents
                : settingsPayload?.data?.showCurrentEvents) ?? true;

            hydrateEventsByDay();
            renderCalendar();

            const hasEvents = state.events.length > 0;

            if (!hasEvents) {
              statusNode.textContent = 'Aucun événement n’est planifié pour le moment. Revenez bientôt !';
              statusNode.classList.add('events-status--muted');
              statusNode.hidden = false;
            } else {
              statusNode.hidden = true;
              statusNode.classList.remove('events-status--muted', 'events-status--error');
            }
          } catch (error) {
          console.error('Erreur lors du chargement des événements', error);
          statusNode.textContent =
            'Impossible de charger les événements pour le moment. Veuillez réessayer plus tard.';
          statusNode.classList.add('events-status--error');

          calendarNode.classList.remove('calendar--loading');
          gridNode.classList.remove('calendar__grid--loading');
          gridNode.innerHTML = '';
          calendarNode.hidden = true;
          }
        }

        loadEvents();
      })();
    </script>
  </body>
</html>
