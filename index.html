<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Terra Indomita &mdash; École de plein air</title>
    <link rel="icon" type="image/png" href="./assets/images/favicon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./assets/css/styles.css" />
  </head>
  <body>
    <header class="hero" id="accueil">
      <div class="hero__overlay">
        <div class="hero__crest">
          <picture>
            <source srcset="./assets/images/logo-crest.svg" type="image/svg+xml" />
            <img src="./assets/images/logo-crest.png" alt="Blason Terra Indomita" />
          </picture>
        </div>
        <div class="hero__content">
          <h1>École de plein air</h1>
          <ul class="hero__list">
            <li>Stage de formation</li>
            <li>Camp immersif</li>
            <li>Mentorat privé</li>
          </ul>
        </div>
      </div>
    </header>

    <main>
      <section class="section section--dark" id="presentation">
        <div class="container two-columns">
          <div class="media">
            <picture>
              <source srcset="./assets/images/logo-crest.svg" type="image/svg+xml" />
              <img src="./assets/images/logo-crest.png" alt="Blason Terra Indomita" class="media__image" />
            </picture>
          </div>
          <div class="copy">
            <p class="eyebrow">Qui sommes-nous</p>
            <p>
              <strong>Terra Indomita</strong> est une école de plein air qui offre des
              stages et des camps immersifs pour développer votre autonomie en plein
              air, en vue d’activités de plein air planifiées ou simplement pour
              approfondir vos connaissances pour le plaisir, ou pour vous préparer à
              faire face à des bris de normalité.
            </p>
          </div>
        </div>
      </section>

      <section class="section section--light" id="services">
        <div class="container">
          <p class="eyebrow eyebrow--dark">Ce que nous offrons</p>
          <div class="offer-grid">
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-stage-formation.jpg"
                  alt="Participants sous un abri en forêt"
                />
              </div>
              <h2>Stage de formation</h2>
              <p>
                Les stages sont la porte d’entrée au monde de l’autonomie en plein
                air. Venez apprendre ou consolider vos connaissances et pratiquer
                dans un cadre éducatif et familial. Accessible, peu importe votre
                condition physique. Disponible aux formats 4 h, 8 h, 48 h et plus.
              </p>
            </article>
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-camp-immersif.jpg"
                  alt="Campement en pleine forêt"
                />
              </div>
              <h2>Camp immersif</h2>
              <p>
                Venez tester vos connaissances et aptitudes dans un événement en
                pleine nature. Construction d’abris naturels, bushcraft, bivouac,
                cuisine en pleine nature, cueillette, chasse et pêche. Comme nos
                arrière-grands-parents !
              </p>
              <p>
                Nécessite une bonne forme physique pour les déplacements en milieu
                sauvage.
              </p>
            </article>
            <article class="offer">
              <div class="offer__image">
                <img
                  src="./assets/images/offre-mentorat-prive.jpg"
                  alt="Lecture de carte et boussole"
                />
              </div>
              <h2>Mentorat privé</h2>
              <p>
                Vous souhaitez définir vos besoins et votre niveau, pour vous,
                vos proches ou votre famille. Nous offrons
                également des stages et des camps immersifs privés.
              </p>
            </article>
          </div>
        </div>
      </section>

      <section class="section section--dark" id="fondateur">
        <div class="container two-columns">
          <div class="media">
            <img
              src="./assets/images/fondateur-alex.jpg"
              alt="Portrait d'Alex, fondateur de Terra Indomita"
              class="media__image"
            />
          </div>
          <div class="copy">
            <p class="eyebrow">À propos du fondateur</p>
            <p>
              Depuis maintenant huit ans, Alex se passionne pour
              la survie en forêt, l’autonomie en plein air, le
              savoir ancestral et bien plus encore.
            </p>
            <p>
              Il s’est formé auprès d’écoles bien établies au
              Québec, telles que Les Primitifs, Kanatha-Aki et
              Un Goût de Forêt. En plus de ses compétences en
              survie et en vie en nature, Alex est secouriste
              formé et cumule plus de dix ans d’expérience dans
              le domaine de la sécurité privée.
            </p>
            <p>
              Après avoir passé plusieurs années à organiser des
              activités de plein air avec sa famille et ses amis,
              il a maintenant décidé de transmettre sa passion au
              plus grand nombre.
            </p>
            <p>
              Alex prône une approche inclusive et sans jugement
              du monde. Le respect, l’entraide et le plaisir font
              partie de ses valeurs profondes.
            </p>
          </div>
        </div>

        </section>

            <section class="section section--light section--events" id="evenements">
        <div class="container">
          <p class="eyebrow eyebrow--dark">Événements</p>
          <p class="section__intro">
            Découvrez nos rendez-vous à venir et suivez l’actualité de Terra Indomita.
          </p>

          <div id="events-status" class="events-status">Chargement des événements…</div>

          <div id="events-groups" class="events-groups" hidden>
            <div class="event-group" data-group="upcoming">
              <h2 class="event-group__title">À venir</h2>
              <div class="event-group__list" role="list"></div>
            </div>

            <div class="event-group" data-group="current" hidden>
              <h2 class="event-group__title">En cours</h2>
              <div class="event-group__list" role="list"></div>
            </div>

            <div class="event-group" data-group="past">
              <h2 class="event-group__title">Passés</h2>
              <div class="event-group__list" role="list"></div>
            </div>
          </div>
        </div>
      </section>

      <template id="event-card-template">
        <article class="event-card" role="listitem">
          <h3 class="event-card__title"></h3>
          <p class="event-card__datetime"></p>
          <p class="event-card__location" hidden></p>
          <p class="event-card__description" hidden></p>
        </article>
      </template>

      <section class="section section--dark section--contacts" id="contact">
        <div class="container">
          <p class="eyebrow">CONTACTS</p>
          <div class="contact-list">
            <a class="contact" href="https://www.facebook.com/profile.php?id=61576874895617" target="_blank" rel="noopener">
              <img
                src="./assets/images/f.webp"
                alt="Facebook"
              />
              <span>Facebook</span>
            </a>
            <a class="contact" href="https://www.instagram.com/terra_indomita_qc" target="_blank" rel="noopener">
              <img
                src="./assets/images/i.webp"
                alt="Instagram"
              />
              <span>Instagram</span>
            </a>
            <a class="contact" href="mailto:terra_indomita@outlook.com">
              <img
                src="./assets/images/@.png"
                alt="Courriel"
              />
              <span>terra_indomita@outlook.com</span>
            </a>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="container">
        <small>© <span id="current-year"></span> Terra Indomita. Tous droits réservés.</small>
      </div>
    </footer>

    <script>
      const yearNode = document.getElementById('current-year');
      if (yearNode) {
        yearNode.textContent = new Date().getFullYear();
      }

      document.querySelectorAll('img').forEach((image) => {
        image.addEventListener('error', () => {
          console.warn('Image introuvable:', image.getAttribute('src'));
        });
      });

      async function loadEvents() {
        const statusNode = document.getElementById('events-status');
        const groupsNode = document.getElementById('events-groups');
        const template = document.getElementById('event-card-template');

        if (!statusNode || !groupsNode || !template) return;

        const EVENTS_URL =
          'https://api.terra-indomita.ca/items/events?sort=start&fields=title,start,end,location,description';
        const SETTINGS_URL = 'https://api.terra-indomita.ca/items/global_settings';

        try {
          const [eventsRes, settingsRes] = await Promise.all([
            fetch(EVENTS_URL, { headers: { Accept: 'application/json' } }),
            fetch(SETTINGS_URL, { headers: { Accept: 'application/json' } }),
          ]);

          if (!eventsRes.ok || !settingsRes.ok) {
            throw new Error(`Bad response: ${eventsRes.status}/${settingsRes.status}`);
          }

          const eventsPayload = await eventsRes.json();
          const settingsPayload = await settingsRes.json();

          const events = eventsPayload?.data ?? [];
          const showCurrent =
            (Array.isArray(settingsPayload?.data)
              ? settingsPayload.data[0]?.showCurrentEvents
              : settingsPayload?.data?.showCurrentEvents) ?? true;

          const now = new Date();
          const groups = { upcoming: [], current: [], past: [] };

          events.forEach((event) => {
            const start = event.start ? new Date(event.start) : null;
            const end = event.end ? new Date(event.end) : null;

            if (!start) {
              groups.past.push(event);
              return;
            }

            if (start > now) {
              groups.upcoming.push(event);
              return;
            }

            if (!showCurrent) {
              groups.past.push(event);
              return;
            }

            if (end && now <= end) {
              groups.current.push(event);
              return;
            }

            if (!end && start.toDateString() === now.toDateString()) {
              groups.current.push(event);
              return;
            }

            groups.past.push(event);
          });

          const dateFormatter = new Intl.DateTimeFormat('fr-CA', { dateStyle: 'long' });
          const timeFormatter = new Intl.DateTimeFormat('fr-CA', { timeStyle: 'short' });

          const formatDateRange = (start, end) => {
            if (!start) return 'Date à confirmer';
            const startDate = new Date(start);
            if (!end) {
              return `${dateFormatter.format(startDate)} · ${timeFormatter.format(startDate)}`;
            }
            const endDate = new Date(end);
            if (startDate.toDateString() === endDate.toDateString()) {
              return `${dateFormatter.format(startDate)} · ${timeFormatter.format(startDate)} – ${timeFormatter.format(endDate)}`;
            }
            return `${dateFormatter.format(startDate)} → ${dateFormatter.format(endDate)}`;
          };

          const renderGroup = (key, label) => {
            const groupWrapper = groupsNode.querySelector(`.event-group[data-group="${key}"]`);
            if (!groupWrapper) return;

            const listNode = groupWrapper.querySelector('.event-group__list');
            listNode.innerHTML = '';

            if (key === 'current' && !showCurrent) {
              groupWrapper.hidden = true;
              return;
            }

            if (!groups[key].length) {
              groupWrapper.hidden = true;
              return;
            }

            groupWrapper.hidden = false;
            groupWrapper.querySelector('.event-group__title').textContent = label;

            groups[key].forEach((event) => {
              const fragment = template.content.cloneNode(true);
              const card = fragment.querySelector('.event-card');
              const titleNode = fragment.querySelector('.event-card__title');
              const datetimeNode = fragment.querySelector('.event-card__datetime');
              const locationNode = fragment.querySelector('.event-card__location');
              const descriptionNode = fragment.querySelector('.event-card__description');

              titleNode.textContent = event.title ?? 'Événement Terra Indomita';
              datetimeNode.textContent = formatDateRange(event.start, event.end);

              if (event.location) {
                locationNode.textContent = event.location;
                locationNode.hidden = false;
              }

              if (event.description) {
                descriptionNode.hidden = false;
                descriptionNode.textContent = '';
                const lines = String(event.description).split(/\r?\n/);
                lines.forEach((line, index) => {
                  if (index > 0) {
                    descriptionNode.appendChild(document.createElement('br'));
                  }
                  descriptionNode.appendChild(document.createTextNode(line));
                });
              }

              listNode.appendChild(card);
            });
          };

          renderGroup('upcoming', 'À venir');
          renderGroup('current', 'En cours');
          renderGroup('past', 'Passés');

          const hasEvents =
            groups.upcoming.length ||
            (showCurrent && groups.current.length) ||
            groups.past.length;

          if (!hasEvents) {
            statusNode.textContent = 'Aucun événement n’est planifié pour le moment. Revenez bientôt !';
            statusNode.classList.add('events-status--muted');
            groupsNode.hidden = true;
          } else {
            statusNode.hidden = true;
            groupsNode.hidden = false;
          }
        } catch (error) {
          console.error('Erreur lors du chargement des événements', error);
          statusNode.textContent =
            'Impossible de charger les événements pour le moment. Veuillez réessayer plus tard.';
          statusNode.classList.add('events-status--error');
          groupsNode.hidden = true;
        }
      }

      if ('fetch' in window && window.matchMedia) {
        loadEvents();
      }
    </script>
  </body>
</html>
